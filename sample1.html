<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Rulik WebSamples</title>
</head>
<body>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script>
        const version = "Sample1 v1.13";
        var portraitMode = true;
        var startAlpha = -1; // -1 - Not initialized.

        function mobile_iOS(){            
            return ['iPad','iPhone'].includes(navigator.platform)
        }

        document.body.style.width = "100vw";
        document.body.style.height = "100vh";
        document.body.style.margin=0;        
        document.body.style.background = "Silver";
        document.body.style.overflow = 'hidden';
        document.body.style.textAlign = "center";

        var ul = document.createElement('ul');        
        ul.style.marginTop = "24px";
        ul.style.display = "inline-block";
        ul.style.listStyle = "none";
        ul.style.paddingLeft = "0"        
        ul.style.textAlign = "center";
        ul.style.marginLeft = "auto";
        ul.style.marginRight = "auto";
    
        document.body.appendChild(ul);

        var demoMode = false;        
        function toggleDemoMode(){
            if(demoMode){
                demoMode = false;
                stopDemo();
            } else {
                demoMode = true;
                startDemo();
            }
        }

        function startDemo() {
            btn.textContent = "Exit Demo";
            startOrientationTracking();
        }                                

        function stopDemo() {
            stopOrientationTracking();            
            btn.textContent = "Start Demo";
            lbl.textContent = version;
        }

        // Create Label
        var lbl = document.createElement("Label");
        lbl.style.display = "inline-block";
        lbl.style.height = '60px';
        lbl.style.width = '200px';
        lbl.style.fontSize = '20px';
        lbl.style.border= "medium solid black"; // width | style | color 
        lbl.style.borderRadius = "10px";
        lbl.style.marginBottom = "58px";
        lbl.style.lineHeight = "60px";
        
        ul.appendChild(lbl);

        // Create canvas area
        var canvas = document.createElement("Canvas");
        canvas.style.display = "inline-block";
        canvas.style.borderRadius = "10px";        
        canvas.style.border = "medium solid black";
        canvas.style.marginBottom = "58px";
               
        ul.appendChild(canvas);

        var btn = document.createElement("Button");
        btn.style.display = "inline-block";
        btn.style.background = 'DeepSkyBlue';
        btn.style.color = 'white';
        btn.style.height = '60px';
        btn.style.width = '180px';
        btn.style.fontSize = '20px';
        btn.style.borderRadius = "10px";
        btn.style.border= "medium solid black"; // width | style | color 
        btn.style.marginBottom = "58px";

        btn.addEventListener("click", toggleDemoMode);
        btn.textContent = "Start Demo";
        
        ul.appendChild(btn)

        function onResize() {
            // Simple detection of protrait / landscape orientation
            if (document.body.clientWidth > document.body.clientHeight){ // Landscape mode
                portraitMode = false;
                canvas.width = document.body.clientHeight * 0.7;
                for (let i = 0; i < ul.children.length; i++) {
                    ul.children[i].style.float = "left";
                    ul.children[i].style.marginRight = "18px";                   
                }                
            } else { // Portrait mode
                portraitMode = true;
                canvas.width = document.body.clientWidth * 0.7;
                for (let i = 0; i < ul.children.length; i++) {
                    ul.children[i].style.float = "none";
                    ul.children[i].style.marginRight = 0;                    
                }
            }
            
            canvas.height = canvas.width;
            if(portraitMode) {
                drawOrientation(0, 35, 0);
            } else {
                drawOrientation(45, -0, -35);
            }
            //lbl.textContent = document.body.clientWidth.toString()+ " " + document.body.clientHeight.toString();            
        }

        onResize();
        window.addEventListener("resize", onResize, false);        
        
        function project(canvas, size, coord) {            
            if(coord < -1.0) {
                coord = -1.0;
            } else if (coord > 1.0) {
                coord = 1.0;
            }
            return canvas.width/2 + (canvas.width/2 - size)*coord;
        }

        function drawCircle(ctx, x, y, radius, color) {
            ctx.beginPath();
            ctx.fillStyle = color;
            ctx.arc(x, y, radius, 0, 2 * Math.PI);            
            ctx.fill();
        }

        function drawOrientation(alpha, beta, gamma) {
            if(startAlpha < 0){
                startAlpha = alpha;
            }
            let x, y;
            const offset = 35.0; // It it common to hold device at 45 degree
            const scale = 15.0; // 15 degree scale
            const radius = 24.0;
            if (portraitMode){
                x = gamma / scale;
                y = (beta - offset) / scale;
            } else {
                x = beta / scale;
                y = -(gamma + offset) / scale;
            }

            const ctx = canvas.getContext("2d");
            ctx.fillStyle = "Gray";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            x = project(canvas, radius, x);
            y = project(canvas, radius, y);
            drawCircle(ctx, x, y, radius,  "DeepSkyBlue");
            
            let alphaAngle = 90 + (startAlpha - alpha)*scale;
            const whiteRadius = radius*2/3.5;
            x = x + whiteRadius * Math.cos(alphaAngle*Math.PI/180);
            y = y - whiteRadius * Math.sin(alphaAngle*Math.PI/180);
            drawCircle(ctx, x, y, whiteRadius/2,  "White");
        }        

        function orientationEventHandler(event){
            const a = event.alpha.toFixed(0); // alpha: rotation around z-axis
            const b = event.beta.toFixed(0); // beta: front back motion
            const g = event.gamma.toFixed(0); // gamma: left to right            
            lbl.textContent = "A: " + a + " B: " + b + " G: " +  g;
            drawOrientation(event.alpha, event.beta, event.gamma);
        }

        function getAccelerometerPermissions(){
            DeviceMotionEvent.requestPermission().then(response => {
                if (response == 'granted') {
                    window.addEventListener("deviceorientation", orientationEventHandler, true);
                }
            });
        }

        function startOrientationTracking(){
            if (window.DeviceOrientationEvent) {
                if(mobile_iOS()){
                    getAccelerometerPermissions();
                } else {
                    window.addEventListener("deviceorientation", orientationEventHandler, true);
                }
            } else {
                lbl.textContent = "Orientation not availanle";                
            }
        }

        function stopOrientationTracking(){
            if (window.DeviceOrientationEvent) {
                window.removeEventListener("deviceorientation", orientationEventHandler, true);    
            }
        }

        lbl.textContent = version;
    </script>
</body>
</html>
